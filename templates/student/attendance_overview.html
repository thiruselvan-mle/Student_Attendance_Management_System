<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Overview</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='student/attendance_view.css') }}">
</head>

<body>

    <!-- BACK BUTTON -->
    <a class="back-btn" href="{{ url_for('student.student_dashboard') }}">‚Üê Back</a>

    <div class="container">

        <!-- HEADER -->
        <div class="header-box">
            <h2>Attendance Overview</h2>

            <!-- Week Navigation -->
            <div class="week-nav">
                <button onclick="changeWeek(-1)">‚¨Ö Previous</button>

                <div class="week-center">
                    <h3 id="weekRange">{{ week_start }} to {{ week_end }}</h3>
                    <button class="calendar-btn"
                        onclick="document.getElementById('calendar').showPicker()">üìÖ</button>
                </div>

                <button onclick="changeWeek(1)">Next ‚û°</button>
            </div>

            <!-- Hidden Calendar -->
            <input type="date" id="calendar"
                   min="{{ sem_start }}"
                   max="{{ sem_end }}"
                   style="visibility:hidden;width:0;height:0;">
        </div>

        <!-- TIMETABLE -->
        <table class="table">
            <thead>
                <tr>
                    <th>Day</th>
                    <th>1st Period</th>
                    <th>2nd Period</th>
                    <th>3rd Period</th>
                    <th>4th Period</th>
                    <th>5th Period</th>
                    <th>6th Period</th>
                    <th>7th Period</th>
                </tr>
            </thead>
            <tbody id="attendanceBody"></tbody>
        </table>

        <p id="noDataMsg" class="no-data" style="display:none;">
            No attendance data available for this date.
        </p>

    </div>

    <!-- ================= JS ================= -->
    <script>
        const SEM_START = new Date("{{ sem_start }}");
        const SEM_END   = new Date("{{ sem_end }}");

        let currentDate = new Date("{{ monday }}");

        // INITIAL LOAD
        loadWeekAttendance(currentDate);

        // WEEK CHANGE
        function changeWeek(offset) {
            const newDate = new Date(currentDate);
            newDate.setDate(newDate.getDate() + offset * 7);

            if (!isWithinSemester(newDate)) {
                alert("Only current semester attendance available");
                return;
            }

            currentDate = newDate;
            loadWeekAttendance(currentDate);
        }

        // LOAD WEEK DATA
        function loadWeekAttendance(date) {

            if (!isWithinSemester(date)) {
                alert("Only current semester attendance available");
                return;
            }

            const start = getMonday(date);
            const end = new Date(start);
            end.setDate(start.getDate() + 4);

            document.getElementById("weekRange").innerText =
                `${format(start)} to ${format(end)}`;

            fetch(`/student/get_week_attendance?date=${format(start)}`)
                .then(res => res.json())
                .then(data => renderAttendance(data));
        }

        // RENDER TABLE

        function renderAttendance(data) {
            const tbody = document.getElementById("attendanceBody");
            tbody.innerHTML = "";

            if (!data || Object.keys(data).length === 0) {
                document.getElementById("noDataMsg").style.display = "block";
                return;
            }

            document.getElementById("noDataMsg").style.display = "none";

            const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];

            days.forEach(day => {
                let row = `<tr><td>${day}</td>`;

                for (let i = 1; i <= 7; i++) {
                    const cell = data[day]?.[i] || { status: null, subject: "" };

                    let cssClass = "no-data";

                    if (cell.status) {
                        const s = cell.status.toLowerCase();

                        if (s === "present" || s === "p") {
                            cssClass = "present";
                        } 
                        else if (s === "absent" || s === "a") {
                            cssClass = "absent";
                        }
                    }

                    row += `
                    <td class="${cssClass}">
                        <strong>${cell.subject || "-"}</strong>
                    </td>`;
                }

                row += "</tr>";
                tbody.innerHTML += row;
            });
        }

        // CALENDAR PICK
        document.getElementById("calendar").addEventListener("change", function () {
            const picked = new Date(this.value);

            if (!isWithinSemester(picked)) {
                alert("Only current semester attendance available");
                return;
            }

            currentDate = picked;
            loadWeekAttendance(picked);
        });

        // HELPERS
        function isWithinSemester(date) {
            return date >= SEM_START && date <= SEM_END;
        }

        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = day === 0 ? -6 : 1 - day;
            d.setDate(d.getDate() + diff);
            return d;
        }

        function format(date) {
            return date.toISOString().split("T")[0];
        }
    </script>

</body>
</html>
